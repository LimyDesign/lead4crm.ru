var me=document.querySelector('script[data-name="cabinet"]'),me_src=me.getAttribute("src"),totalChecked=0,totalFind=0,qty=0,ii=null,connected=false,contract=getParamByName("c"),new_contract="",icq_uin_start=0,icq_uin_change=0,icq_notify_start="",icq_notify_change="",sms_phone_start=0,sms_phone_change=0,sms_notify_start="",sms_notify_change="",email_address_start="",email_address_change="",email_notify_start="",email_notify_change="";$(document).ready(function(){greeting("#greeting");$("#kk_help").tooltip({placement:"auto"});$('[data-toggle="tooltip"]').tooltip({placement:"auto"});$.post("/getUserData/",function(c){$("#balans").number(c.balans,2,"."," ");$("#tariff").text(c.tariff);$("#qty").number(c.qty,0,"."," ");qty=c.qty},"json");if(contract=="f"&&new_contract==""){$("#termsModal").modal({backdrop:"static",keyboard:false,show:true})}$("#termsModal #decline").click(function(){$("#termsModal").find("button").attr("disabled","disabled");$.post("/contract/",{decision:false}).done(function(){window.location="/logout/"})});$("#termsModal #accept").click(function(){$("#termsModal").find("button").attr("disabled","disabled");$.post("/contract/",{decision:true},function(c){new_contract=c},"html").done(function(){$("#termsModal").modal("hide")})});var a=1;$("#wizard-form").submit(function(c){c.preventDefault();var h=$(this).attr("action");var k=$(this).find("#selectCRM").val();var g=$(this).find("#selectCity").val();var i=$(this).find('input[name="searchType"]:checked').val();var e=$(".wizard").offset(),f=$(".wizard").height();$(this).find("fieldset").attr("disabled","disabled");$(".overlay").css({top:e.top,left:e.left}).height(f).fadeIn("fast");if(h!="/showSearchDialog/"){if($("#ii").hasClass("hide")===false){$("#ii").addClass("hide")}if($("#ii_help").hasClass("hide")===false){$("#ii_help").addClass("hide")}}if(h=="/step-1/"){$(".overlay").fadeOut();$(this).find("fieldset").removeAttr("disabled");$(this).attr("action","/step-2/");$("#wizard-helper #step-"+a).fadeOut("fast",function(){$("#wizard-helper #step-1").fadeIn("fast")});$("#wizard-form #step-"+a).fadeOut("fast",function(){$("#wizard-form #step-1").fadeIn("fast")})}else{if(h=="/step-2/"){if(k!=null){localStorage.setItem("crm_id",k);$.post(h,{crm_id:k},function(l){$(".overlay").fadeOut();$("#wizard-form").find("fieldset").removeAttr("disabled");if(l.error=="0"){if(l.module){renderSelections(9999);a=9999;$("#wizard-form").attr("action","/step-1/");$("#wizard-helper #step-1").fadeOut("fast",function(){$("#wizard-helper #step-9999").fadeIn("fast")});$("#wizard-form #step-1").fadeOut("fast",function(){$("#wizard-form #step-9999").find("#module-link").attr("href",l.module);$("#wizard-form #step-9999").find("#module-name").text(l.name);$("#wizard-form #step-9999").fadeIn("fast")})}else{a=2;ii=l.ii;$("#wizard-form").attr("action","/step-3/");$("#wizard-helper #step-1").fadeOut("fast",function(){$("#wizard-helper #step-2").fadeIn("fast")});$("#wizard-form #step-1").fadeOut("fast",function(){$("#wizard-form #step-2").fadeIn("fast")})}}},"json")}else{$(".overlay").fadeOut();$("#wizard-form").find("fieldset").removeAttr("disabled")}}else{if(h=="/step-3/"){if(g!=null){localStorage.setItem("city_id",g);$(".overlay").fadeOut();$("#wizard-form").find("fieldset").removeAttr("disabled");a=3;$("#wizard-form").attr("action","/step-4/");$("#wizard-helper #step-2").fadeOut("fast",function(){$("#wizard-helper #step-3").fadeIn("fast")});$("#wizard-form #step-2").fadeOut("fast",function(){$("#wizard-form #step-3").fadeIn("fast")})}else{$(".overlay").fadeOut();$("#wizard-form").find("fieldset").removeAttr("disabled")}}else{if(h=="/step-4/"){if(i!=null){if(ii!=null){$("#ii").removeClass("hide");$("#ii_help").removeClass("hide");$.post("/getIntegrated/",{ii:ii},function(l){$("#ii_html").html(l.html);connected=l.connected},"json").done(function(){$(".overlay").fadeOut();localStorage.setItem("search_id",i);renderSelections(4);$("#wizard-form").find("fieldset").removeAttr("disabled");a=4;$("#wizard-form").attr("action","/showSearchDialog/");$("#wizard-helper #step-3").fadeOut("fast",function(){$("#wizard-helper #step-4").fadeIn("fast")});$("#wizard-form #step-3").fadeOut("fast",function(){$("#wizard-form #step-4").fadeIn("fast")})})}else{$(".overlay").fadeOut();localStorage.setItem("search_id",i);renderSelections(4);$("#wizard-form").find("fieldset").removeAttr("disabled");a=4;$("#wizard-form").attr("action","/showSearchDialog/");$("#wizard-helper #step-3").fadeOut("fast",function(){$("#wizard-helper #step-4").fadeIn("fast")});$("#wizard-form #step-3").fadeOut("fast",function(){$("#wizard-form #step-4").fadeIn("fast")})}}}else{if(h=="/showSearchDialog/"){if(i==1){$("#searchDialog-"+i).find("dl").empty();if(localStorage.getItem("2GISRubrics")){var j=JSON.parse(localStorage.getItem("2GISRubrics"));rubricListConstructor(j);showSearchDialog(i,k,g)}else{var d={importAPI:getParamByName("k"),importDomain:"www.lead4crm.ru"};$.post("/getRubricList/",d,function(l){if(l.error==0){if(l.rubrics){localStorage.setItem("2GISRubrics",JSON.stringify(l.rubrics));rubricListConstructor(l.rubrics)}}},"json").done(function(){showSearchDialog(i,k,g)})}}else{showSearchDialog(i,k,g)}}}}}}});var b="";$("#searchDialog-0 form").submit(function(d){d.preventDefault();var c=$(this).find("#searchInput").val();if(c!=b&&c!=""){b=c;renderPage(1,c)}});$("[id^=searchDialog-] #ok").click(function(){if(qty<totalChecked){alert("Вы указали слишком большое кол-во компаний для импорта.\n\nВы можете импортировать всего: "+qty);return}else{if(totalChecked>0){var i=0;var h=1;var c=0,d="";var e=Math.floor(100/totalChecked);var j=$(this);var g=$(this).parent().parent();var k=g.find(".progress");var f=0;$(this).attr("disabled","disabled");k.fadeIn("fast",function(){k.find(".progress-bar").addClass("progress-bar-striped").css("width","0%").text("0%");for(h=1;h<=(totalFind>50?50:totalFind);h++){f=g.find("#company"+h);if(f.prop("checked")){c=f.attr("name");d=f.attr("value");importCompany(c,d,true,function(){totalChecked--;k.find(".progress-bar").css("width",function(l,m){var n=k.width();i+=e;return n/(totalChecked+1)}).text(i+"%");if(totalChecked>0){j.html("Импортировать отмеченные <notr>("+totalChecked+")</notr>")}else{k.find("progress-bar").removeClass("progress-bar-striped").css("width","100%").text("100%");j.text("Импортировать отмеченные")}})}}setTimeout(function(){k.fadeOut("slow")},2000)})}}});$('input[name="searchType"]').click(function(){$(this).parent().parent().find("label.active").removeClass("active");$(this).parent().addClass("active")});$("[id^=searchDialog-]").on("hidden.bs.modal",function(c){renderSelections(4);$(".overlay").fadeOut();$("#wizard-form").find("fieldset").removeAttr("disabled")});$("#searchDialog-0").on("shown.bs.modal",function(){var c=$(this);c.find('input[type="text"]').focus()});$('a[data-toggle="tab"]').on("shown.bs.tab",function(d){var c=$(d.target).attr("href").substring(1);if(c=="tabAPIKey"){selectText("apikey")}else{if(c=="tabNotification"){getSMSInfo("79041326000")}}});$("body").on("mouseup",".well",function(){selectText("apikey")});$("body").on("click","#newapikey",function(){var c=$(this);c.addClass("disabled");c.find("i.fa").removeClass("fa-key");c.find("i.fa").addClass("fa-spinner fa-pulse");$.get("/newAPIKey/",function(d){$("#apikey").text(d)}).done(function(){c.removeClass("disabled");c.find("i.fa").removeClass("fa-spinner fa-pulse");c.find("i.fa").addClass("fa-key");selectText("apikey")})});$("body").on("click",".option li",function(){var d=$(this).parents(".select").attr("id");var c=$(this).children().html();var e=$(this).attr("id");$("#"+d+" .selected").attr("id",e);$('input[name="paymentType"]').val(e);$("#"+d+" .selected").html(c)});$("#yaform").submit(function(){$("#inputSum").number(true,2,".","");if($("#inputSum").val()>=100){return true}else{$("#inputSum").number(true,2,"."," ");return false}});$("#inputSum").number(true,2,"."," ");$("#inputInvoiceSum").number(true,2,"."," ");$("#tariffForm").submit(function(f){f.preventDefault();if($('select[name="tariff"]').val()!="demo"){var c=$(this).attr("action");var d=$(this).serialize();$("#tariffModal").modal("show");$("#tariffModal").find("#ok").on("click",function(){var e=$(this);var g=e.text();e.addClass("disabled");e.html('<i class="fa fa-fw fa-spinner fa-pulse"></i> '+g);$.post(c,d,function(h){$("#qty").number(h.qty,0,"."," ");$("#balans").number(h.balans,2,"."," ");$("#tariff").text(h.tariff)},"json").done(function(){$("#tariffModal").modal("hide");e.removeClass("disabled");e.text(g)})})}});icq_uin_start=icq_uin_change=$("#inputICQUIN").val();$("#inputICQUIN").change(function(){icq_uin_change=$(this).val()});$('#formICQSetting input[name^="notify"]:checked').each(function(){icq_notify_start+=$(this).val();icq_notify_change=icq_notify_start});$('#formICQSetting input[name^="notify"]').change(function(){icq_notify_change="";$('#formICQSetting input[name^="notify"]:checked').each(function(){icq_notify_change+=$(this).val()})});$("#formICQSetting").submit(function(g){g.preventDefault();var d=$("#inputICQUIN").val(),c=$("#inputICQCode").val(),h=$(this).find("fieldset"),f=$(this).serialize();h.attr("disabled","disabled");if(isInt(d)&&d!=""){if(d!=getParamByName("icq")&&c==""){sendCode(d);$("#resendICQCode").attr("onclick","sendCode("+d+")");if($("#groupICQUIN").hasClass("has-error")){$("#groupICQUIN").removeClass("has-error")}$("#groupICQUIN").addClass("has-success");$("#groupICQCode").removeClass("hide");scrollTo("#inputICQCode");h.removeAttr("disabled");$("#inputICQCode").focus()}else{if(icq_uin_start!=icq_uin_change||icq_notify_start!=icq_notify_change){$.post("/icq/save/",f,function(e){if(e=="error_code"){$("#groupICQCode").addClass("has-error");scrollTo("#groupICQCode");h.removeAttr("disabled");$("#inputICQCode").focus()}else{icq_uin_start=icq_uin_change;icq_notify_start=icq_notify_change;h.removeAttr("disabled");if($("#groupICQUIN").hasClass("has-success")){$("#groupICQUIN").removeClass("has-success")}if($("#groupICQUIN").hasClass("has-error")){$("#groupICQUIN").removeClass("has-error")}$("#groupICQCode").addClass("hide");$("#statusICQSetting").removeClass("hide");scrollTo("#statusICQSetting");setTimeout(function(){$("#statusICQSetting").addClass("hide")},5000)}})}else{h.removeAttr("disabled")}}}else{$("#groupICQUIN").addClass("has-error");h.removeAttr("disabled");scrollTo("#groupICQUIN");$("#inputICQUIN").focus()}});sms_phone_start=sms_phone_change=$("#inputSMSPhone").val();$("#inputSMSPhone").change(function(){sms_phone_change=$(this).val();getSMSInfo(sms_phone_change)});$('#formSMSSetting input[name^="notify"]:checked').each(function(){sms_notify_start+=$(this).val();sms_notify_change=sms_notify_start});$('#formSMSSetting input[name^="notify"]').change(function(){sms_notify_change="";$('#formSMSSetting input[name^="notify"]:checked').each(function(){sms_notify_change+=$(this).val()})});$("#refreshSMSUser").click(function(f){f.preventDefault();var c=$("#inputSMSPhone").val();var g=$(this).text(),d=0;var h=setInterval(function(){if(d<3){$("#refreshSMSUser").append(".");d++}else{d=0;$("#refreshSMSUser").text(g)}},200);getSMSInfo(c,function(){clearInterval(h);$("#refreshSMSUser").text(g)})});$("#formSMSSetting").submit(function(g){g.preventDefault();var c=$("#inputSMSPhone").val(),d=$("#inputSMSCode").val(),h=$(this).find("fieldset"),f=$(this).serialize();h.attr("disabled","disabled");if(isPhone(c)){getSMSInfo(c,function(e,j){if(e===false){return}else{if(c!=getParamByName("sms")&&d==""){j=j.toFixed(2);var i=confirm("Стоимость подтверждения номера будет составлять: "+j+" руб.\nВы согласны?");if(i){sendSMSCode(c);$("#resendSMSCode").attr("onclick","sendSMSCode("+c+")");if($("#groupSMSPhone").hasClass("has-error")){$("#groupSMSPhone").removeClass("has-error")}$("#groupSMSPhone").addClass("has-success");$("#groupSMSCode").removeClass("hide");scrollTo("#inputSMSCode");h.removeAttr("disabled");$("#inputSMSCode").focus()}else{h.removeAttr("disabled");return}}else{if(sms_phone_start!=sms_phone_change||sms_notify_start!=sms_notify_change){$.post("/sms/save/",f,function(k){if(k.error==100){$("#groupSMSCode").addClass("has-error");scrollTo("#groupSMSCode");h.removeAttr("disabled");$("#inputSMSCode").focus()}else{if(k.error==200){scrollTo("#alertSMSUser");$("#alertSMSUser").removeClass("hide")}else{sms_phone_start=sms_phone_change;sms_notify_start=sms_notify_change;h.removeAttr("disabled");if($("#groupSMSPhone").hasClass("has-success")){$("#groupSMSPhone").removeClass("has-success")}if($("#groupSMSPhone").hasClass("has-error")){$("#groupSMSPhone").removeClass("has-error")}$("#groupSMSCode").addClass("hide");$("#statusSMSSetting").removeClass("hide");scrollTo("#statusSMSSetting");setTimeout(function(){$("#statusSMSSetting").addClass("hide")},5000)}}},"json")}else{h.removeAttr("disabled")}}}})}else{$("#groupSMSPhone").addClass("has-error");h.removeAttr("disabled");scrollTo("#groupSMSPhone");$("#inputSMSPhone").focus()}});email_address_start=email_address_change=$("#inputEmailAddress").val();$("#inputEmailAddress").change(function(){email_address_change=$(this).val()});$('#formEmailSetings input[name^="notify"]:checked').each(function(){email_notify_start+=$(this).val();email_notify_change=email_notify_start});$('#formEmailSetings input[name^="notify"]').change(function(){email_notify_change="";$('#formEmailSetings input[name^="notify"]:checked').each(function(){email_notify_change+=$(this).val()})});$("#formEmailSetings").submit(function(f){f.preventDefault();var c=$("#inputEmailAddress").val(),g=$(this).find("fieldset"),d=$(this).serialize();g.attr("disabled","disabled");if(isEmail(c)){if($("#groupEmailAddress").hasClass("has-error")){$("#groupEmailAddress").removeClass("has-error")}$("#groupEmailAddress").addClass("has-success");if(c!=getParamByName("email")){sendEmail("code",d,function(){if($("#groupEmailAddress").hasClass("has-success")){$("#groupEmailAddress").removeClass("has-success")}$("#statusEmailCode").removeClass("hide");scrollTo("#statusEmailCode")})}else{if(email_address_start!=email_address_change||email_notify_start!=email_notify_change){sendEmail("change",d,function(){email_address_start=email_address_change;email_notify_start=email_notify_change;if($("#groupEmailAddress").hasClass("has-success")){$("#groupEmailAddress").removeClass("has-success")}$("#statusEmailSetting").removeClass("hide");scrollTo("#statusEmailSetting");setTimeout(function(){$("#statusEmailSetting").addClass("hide")},5000);g.removeAttr("disabled")})}else{g.removeAttr("disabled")}}}else{$("#groupEmailAddress").addClass("has-error");g.removeAttr("disabled");scrollTo("#groupEmailAddress");$("#inputEmailAddress").focus()}})});function greeting(a){var e=new Date(),b=e.getHours(),c=$(a);if(b>=5&&b<12){c.text("Доброе утро!")}else{if(b>=12&&b<18){c.text("Добрый день!")}else{if(b>=18&&b<24){c.text("Добрый вечер!")}else{c.html("Доброй ночи&hellip;")}}}}function scrollTo(a){$("html, body").animate({scrollTop:$(a).offset().top-$("#header").outerHeight()-20},1000)}function wizardStep(b){var a=b+1;if($("#ii").hasClass("hide")===false){$("#ii").addClass("hide")}if($("#ii_help").hasClass("hide")===false){$("#ii_help").addClass("hide")}$("#wizard-form").attr("action","/step-"+a+"/");$("#wizard-helper #step-"+a).fadeOut("fast",function(){$("#wizard-helper #step-"+b).fadeIn("fast")});$("#wizard-form #step-"+a).fadeOut("fast",function(){$("#wizard-form #step-"+b).fadeIn("fast")})}function renderSelections(b){var a=localStorage.getItem("crm_id");$.post("/getUserCache/",function(g){var e,h,d=new Date(),d=d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2),c=$("#wizard-form #step-"+b).find("div.list-group");c.empty();for(var f in g){e=g[f].addtime.substring(0,7);if(e!=h){if(e==d){c.append('<a href="#." class="list-group-item active" onclick=downloadSelection("'+e+'",'+a+")>Скачать выборку за "+e+"</a>")}else{c.append('<a href="#." class="list-group-item" onclick=downloadSelection("'+e+'",'+a+")>Скачать выборку за "+e+"</a>")}h=e}}})}function downloadSelection(d,a){if(connected){var c=confirm("Начать экспорт в вашу CRM?\n\nЕсли вы хотите скачать файл, то отключитесь от CRM, нажав на соответствующую красную кнопку.");if(c){exportSelection(d,a)}}else{var b=window.open("/getSelection/"+d+"/?crm_id="+a);window.setTimeout(function(){b.close()},10000)}}function exportSelection(g,b,c,a,f){c=typeof c!=="underfined"?c:false;a=typeof a!=="underfined"?a:0;f=typeof f!=="underfined"?f:null;var e=$("#exportDialog");if(c){var d=Math.round((a+1)*100/f.total);if(a==f.total){setTimeout(function(){e.modal("hide")},2000)}else{$.post("/crmPostCompany/"+ii+"/",{opt:f.opt[a]},function(h){if(h){if(h.status.code=="error"){alert(h.status.message)}else{if(h.status.code=="warning"){e.find("#status").css("color","#d43f3a").text(" дубликат.")}else{e.find("#status").css("color","#4cae4c").text(" добавлена.")}}}else{e.modal("hide")}},"json").done(function(){e.find(".progress-bar").attr("aria-valuenow",d);e.find(".progress-bar").css("width",d+"%");e.find(".progress-bar").text(d+"%");e.find("#companyName").text(f.opt[a].name);a++;exportSelection(g,b,true,a,f)})}}else{e.find(".progress-bar").attr("aria-valuenow","0");e.find(".progress-bar").css("width","0");e.find(".progress-bar").text("0%");e.find("#companyName").text("n/a");e.modal({backdrop:false,keyboard:false,show:true});$.post("/getSelectionArray/"+g+"/",{crm_id:b,json:true,addon:true},function(h){exportSelection(g,b,true,0,h)},"json")}}function showSearchDialog(a){$("#searchDialog-"+a).modal({backdrop:false})}function rubricListConstructor(b){var c=null,a=null;b.forEach(function(d){if(!d.parent){$("#searchDialog-1").find("dl").append('<dt><a href="#." title="'+d.name+'" id="r-'+d.id+'" onclick="searchByID('+d.id+')">'+d.name+"</a></dt>");c=d.id}else{if(c==d.parent){$("#searchDialog-1").find("dl").append('<dd id="'+d.id+'"><a href="#." class="btn btn-xs btn-primary" id="r-'+d.id+'" onclick="searchByID('+d.id+')">'+d.name+"</a></dd>");a=d.id}else{if(a==d.parent){$("#searchDialog-1").find("dl dd#"+a).append(' <a href="#." class="btn btn-xs btn-default" id="r-'+d.id+'" onclick="searchByID('+d.id+')">'+d.name+"</a>")}}}})}function searchByID(b){if(b==0){$("#searchDialog-1 #ok").attr("disabled","disabled");$("#searchDialog-1 #helper").empty().html("Кликните по любому виду деятельности. <em>Это не страшно.</em> &#128521;");$("#searchDialog-1").find("#searchResult").hide(400,function(){$(".dl-horizontal").show()})}else{var a=$("#searchDialog-1").find("#r-"+b).text();$("#searchDialog-1 #helper").empty().html('Искомый вид деятельности: <div class="btn-group btn-group-xs" role="group" aria-label="..."><button type="button" class="btn btn-invert">'+a+'</button><button type="button" class="btn btn-danger" onclick="searchByID(0)">&times;</button>');renderPage(1,a,function(){$(".dl-horizontal").hide(400,function(){$("#searchDialog-1").find("#searchResult").show()})})}}function chMarkAll(b){var c=$("#searchDialog-"+b).find("#selectAllID:checked").length;var a=$("#searchDialog-"+b).find("#ok");console.log(c);if(!c){totalChecked=0;a.attr("disabled","disabled").html("Импортировать отмеченные")}else{if(totalFind>50){totalChecked=50}else{totalChecked=totalFind}a.removeAttr("disabled").html("Импортировать отмеченные <notr>("+totalChecked+")</notr>")}$("#searchDialog-"+b+" tbody tr").find("td:first :checkbox").each(function(){$(this).prop("checked",c)})}function renderPage(e,b,g){totalChecked=0;var f={searchAPI:getParamByName("k"),searchDomain:"www.lead4crm.ru",searchCity:localStorage.getItem("city_id"),searchPage:e};var d="",c=localStorage.getItem("search_id"),a;$.post("/getUserCache/",function(h){a=h});$("#searchDialog-"+c+" #page"+e).html('<span><i class="fa fa-circle-o-notch fa-spin"></i></span>');$("#searchDialog-"+c+" tbody").find("tr").remove().append('<tr class="notr"><td colspan="5" class="text-center"><i class="fa fa-fw fa-spinner fa-pulse"></i> Построение списка компаний&hellip;</td></tr>');if(c==1){f.searchRubric=b;d="/getDataSearchRubric/"}else{f.searchText=b;d="/getDataSearch/"}$.post(d,f,function(o){totalFind=o.total;$("#qty").number(o.qty,0,"."," ");$("#searchDialog-"+c).find(".btn-invert").text(b+" ("+o.total+")");$("#searchDialog-"+c).find(".pagination").empty();$("#searchDialog-"+c+" tbody").find("tr").remove();if(e==1){$("#searchDialog-"+c+" .pagination").append('<li class="active" id="page1"><span>1 <span class="sr-only">(текущая)</span></span></li>');if(totalFind>50){var n=2;for(var m=50;m<totalFind;m=m+50){$("#searchDialog-"+c+" .pagination").append('<li id="page'+n+'"><a href="#." onclick="renderPage('+n+",'"+b+"')\">"+n+"</a></li>");n++}}}else{if(totalFind>50){var n=1;for(var m=0;m<totalFind;m=m+50){if(n==e){$("#searchDialog-"+c+" .pagination").append('<li class="active" id="page'+n+'"><span>'+n+' <span class="sr-only">(текущая)</span></span></li>')}else{$("#searchDialog-"+c+" .pagination").append('<li id="page'+n+'"><a href="#." onclick="renderPage('+n+",'"+b+"')\">"+n+"</a></li>")}n++}}}var j=null,l=0,k=0,h,p=new Date(),p=p.getFullYear()+"-"+("0"+(p.getMonth()+1)).slice(-2);o.result.forEach(function(t,r){var q=r+1;for(var s in a){if(a[s].id==t.id&&a[s].addtime.substring(0,7)==p){l=1;k=0;h=a[s].addtime.substring(0,10);break}else{if(a[s].id==t.id&&a[s].addtime.substring(0,7)!=p){l=0;k=1;h=a[s].addtime.substring(0,10);break}else{l=0;k=0}}}if(l){$("#searchDialog-"+c).find("tbody").append('<tr class="notr success"><td class="text-center"><input type="checkbox" name="'+t.id+'" value="'+t.hash+'" onclick=changeMark("'+t.id+'") id="company'+q+'" disabled></td><td>'+t.name+"</td><td>"+t.address+"</td><td>"+t.firm_group+"</td><td>Импортровано: <nobr>"+h+"</nobr></td></tr>")}else{if(k){$("#searchDialog-"+c).find("tbody").append('<tr class="notr warning"><td class="text-center"><input type="checkbox" name="'+t.id+'" value="'+t.hash+'" onclick=changeMark("'+t.id+'") id="company'+q+'"></td><td>'+t.name+"</td><td>"+t.address+"</td><td>"+t.firm_group+'</td><td><a href="#." class="btn btn-xs btn-warning" data-toggle="tooltip" title="Испортировано: '+h+'" onclick=importCompany("'+t.id+'","'+t.hash+'",true)>Импортировать</a></td></tr>')}else{totalChecked++;$("#searchDialog-"+c).find("tbody").append('<tr class="notr"><td class="text-center"><input type="checkbox" name="'+t.id+'" value="'+t.hash+'" onclick=changeMark("'+t.id+'") id="company'+q+'" checked></td><td>'+t.name+"</td><td>"+t.address+"</td><td>"+t.firm_group+'</td><td><a href="#." class="btn btn-xs btn-default" onclick=importCompany("'+t.id+'","'+t.hash+'")>Импортировать</a></td></tr>')}}})},"json").done(function(){var h=$("#searchDialog-"+c).find("#ok");if(totalChecked>0){h.removeAttr("disabled").html("Импортировать отмеченные <notr>("+totalChecked+")</notr>")}else{h.attr("disabled","disabled").html("Импортировать отмеченные")}if(g&&typeof(g)==="function"){g()}})}function importCompany(h,c,f,g){f=typeof f!=="underfined"?f:false;var a={importAPI:getParamByName("k"),importDomain:"www.lead4crm.ru",importCompanyID:h,importCompanyHash:c,getFrom2GIS:f};var e=new Date(),e=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2),b=localStorage.getItem("search_id");$("#searchDialog-"+b).find('input[name="'+h+'"]').parent().parent().find("td:eq(4) a").html('<i class="fa fa-fw fa-spinner fa-pulse"></i> Загрузка&hellip;');$.post("/importCompany/",a,function(d){if(d.error>0){alert(d.message)}},"json").done(function(){$("#searchDialog-"+b).find('input[name="'+h+'"]').attr("disabled","disabled").prop("checked",0).parent().parent().removeClass().addClass("success").find("td:eq(4)").html("Импортировано: <nobr>"+e+"</nobr>");if(g&&typeof(g)==="function"){g()}})}function changeMark(d){var b=$('input[name="'+d+'"]:checked').length;var c=localStorage.getItem("search_id");var a=$("#searchDialog-"+c).find("#ok");if(b){totalChecked++}else{totalChecked--}if(totalChecked>0){a.removeAttr("disabled").html("Импортировать отмеченные <notr>("+totalChecked+")</notr>")}else{a.attr("disabled","disabled").html("Импортировать отмеченные")}}function selectText(b){var d=document;var e=d.getElementById(b);if(d.body.createTextRange){var a=d.body.createTextRange();a.moveToElementText(e);a.select()}else{if(window.getSelection){var c=window.getSelection();var a=d.createRange();a.selectNodeContents(e);c.removeAllRanges();c.addRange(a)}}}function sendCode(a){if(!$("#resendICQCode").prop("disabled")){$("#resendICQCode").attr("disabled","disabled")}$.post("/icq/sendCode/",{uin:a},function(b){setTimeout(function(){$("#resendICQCode").removeAttr("disabled")},60000)})}function sendSMSCode(a,c){if(!$("#resendSMSCode").prop("disabled")){$("#resendSMSCode").attr("disabled","disabled")}var b;$.post("/sms/sendCode/",{phone:a},function(e){if(e.response.code=="100"){b=e.response.ids[0];var d=setInterval(function(){$.post("/sms/getStatus/",{phone:b},function(f){if(f.response.code>102||f.response.code==""){clearInterval(d);$("#resendSMSCode").removeAttr("disabled");if(f.response.code==103){var g=$("#balans").text().replace(/\s/g,"")-f.response.cost.toFixed(2);$("#balans").number(g,2,"."," ")}}})},2000)}else{$("#resendSMSCode").removeAttr("disabled")}},"json").done(function(){if(c&&typeof(c)==="function"){c()}})}function getSMSInfo(b,c){var a=false;$.post("/sms/getInfo/",{phone:b},function(d){cost=d.agregator.cost;if(d.agregator.limit.limit==d.agregator.limit.current||d.agregator.balance.balance<=0){$("#formSMSSetting fieldset").attr("disabled","disabled");$("#alertSMSService").removeClass("hide")}else{if(cost>d.balance){$("#formSMSSetting fieldset").attr("disabled","disabled");$("#sms_price").number(cost,2,"."," ");$("#alertSMSUser").removeClass("hide")}else{$("#sms_price").number(cost,2,"."," ");a=true}}},"json").done(function(){if(c&&typeof(c)==="function"){c(a,cost)}})}function sendEmail(a,b,c){$.post("/email/"+a+"/",b).always(function(){if(c&&typeof(c)==="function"){c()}})}function isInt(a){return a%1===0}function isPhone(b){var a=b.replace(/[^0-9]/g,"");if(a.match(/^(7|8)/g)&&a.length==11){return 1}else{return 0}}function isEmail(b){var a=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;return a.test(b)}function getParamByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(me_src);return b===null?"":decodeURIComponent(b[1].replace(/\+/g," "))};