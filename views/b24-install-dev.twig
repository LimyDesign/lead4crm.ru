{% if isAdmin %}
{% spaceless %}
<!DOCTYPE html>
<html>
<head>
	{% include 'layout/header.twig' %}
	<link rel="stylesheet" href="/public/css/bootstrap-select.min.css">
</head>
<body>
	<div id="wraper">
		<section class="main">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h2 id="greeting">Добрый день!</h2>
						<p class="lead">Спасибо что выбрали наше приложение. Мы старались его сделать максимально удобным и функциональным. Для правильной работы приложения требуется указать всего пару параметров.</p>
						<form id="bxAppOptionsForm">
							<div class="form-group">
								<label for="inputAPIKey">Ключ доступа</label>
								<input name="apikey" type="text" class="form-control input-lg" id="inputAPIKey" placeholder="Введите персональный ключ доступа" value="{{apikey}}" aria-describedby="helpAPIKey">
								<span id="helpAPIKey" class="help-block">Ключ доступа можно найти в личном кабинете на сайте модуля <a href="http://www.lead4crm.ru" target="_blank">www.lead4crm.ru</a>. Если вы уже авторизованы на сайте <a href="http://www.lead4crm.ru" target="_blank">www.lead4crm.ru</a>, то скорее всего данное поле заполнено автоматически и вам не нужно никуда более переходить, достаточно просто выбрать правильный город и сохранить настройки.</span>
							</div>
							<div class="form-group">
								<label for="selectCityName">Выберите ваш город</label>
								<select name="city" class="selectpicker form-control input-lg" id="selectCityName" aria-describedby="helpCityName" data-live-search="true" data-width="100%">
									<option value="0">[ выберите ваш город ]</option>
									{% for city in cities %}
										{% if city.selected %}
											<option value="{{city.code}}" selected>{{city.name}}</option>
										{% else %}
											<option value="{{city.code}}">{{city.name}}</option>
										{% endif %}
									{% endfor %}
								</select>
								<span id="helpCityname" class="help-block">Выберите город в котором работает ваша компания. По-умолчанию выбирается тот город, который указан в вашей карточке, если конечно данное поле заполнено правильно и ваш город есть в списке поддерживаемых городов.</span>
							</div>
							<button class="btn btn-primary btn-lg rounded" type="submit">
								<i class="fa fa-floppy-o fa-fw"></i> Сохранить
							</button>
						</form>
					</div>
				</div>
			</div>
		</section>
	</div>
	<script type="text/javascript" src="//api.bitrix24.com/api/v1/"></script>
	{% include 'layout/scripts.twig' %}
	<script src="/public/js/bootstrap-select.min.js"></script>
</body>
</html>
{% endspaceless %}
{% jshrink %}
<script>
// Инициализируем Битрикс24
BX24.init(function() {
	// Меняем приветствие в зависимости от времени суток
	BX24.callMethod('user.current', {}, function(res) {
		d = new Date();
		h = d.getHours();
		g = $('#greeting');
		if (h >= 5 && h < 12) {
			g.text('Доброе утро, ' + res.data().NAME + '!');
		} else {
			if (h >= 12 && h < 18) {
				g.text('Добрый день, ' + res.data().NAME + '!');
			} else {
				if (h >= 18 && h < 24) {
					g.text('Добрый вечер, ' + res.data().NAME + '!');
				} else {
					if (h >= 0 && h < 5) {
						g.text('Доброй ночи, ' + res.data().NAME + '!');
					}
				}
			}
		}
	});

	// Делаем удобный выбор городов, иначе полная лабуда
	$('.selectpicker').selectpicker();

	// Меняем заголов в Битрикс24
	BX24.setTitle('Настройка приложения «Генератор лидов»');

	var b24APIKey = BX24.appOption.get('LEAD4CRM_APIKEY');
	var b24CityID = BX24.appOption.get('LEAD4CRM_CITYID');
	if (b24APIKey && b24CityID) {
		$('#bxAppOptionsForm').find('input[name="apikey"]').val(b24APIKey);
		$('#bxAppOptionsForm').find('select[name="city"]').val(b24CityID);
	}

	// Сохраняем данные формы в Битрикс24
	// и переходим после в само приложение
	$('#bxAppOptionsForm').submit(function(e) {
		// Перехватываем событие по-умолчанию
		e.preventDefault();

		$(this).find('button').attr('disabled', 'disabled');
		$(this).find('input[name="apikey"]').attr('disabled', 'disabled');
		$(this).find('select[name="city"]').attr('disabled', 'disabled');
		$(this).find('button i').removeClass('fa-floppy-o').addClass('fa-spinner fa-pulse');
		
		// Получаем данные из формы
		var k = $(this).find('input[name="apikey"]').val();
		var c = $(this).find('select[name="city"]').val();
		
		// Сохраняем параметры приложения в Битрикс24
		BX24.appOption.set('LEAD4CRM_APIKEY', k, function(callback) {
			if (callback.LEAD4CRM_APIKEY) {
				BX24.appOption.set('LEAD4CRM_CITYID', c, function(callback) {
					if (callback.LEAD4CRM_CITYID) {
						// Сообщаем Битрикс24 о том, что все готово
						// и можно переключаться на приложение.
						BX24.installFinish();
						var prevURL = document.createElement('a');
						prevURL.href = document.referrer;
						if (prevURL.hostname == 'www.lead4crm.ru') {
							BX24.reloadWindow();
						}
					}
				})
			}
		});
	});
});

// Изменяем размер фрейма под текущие контент
BX24.fitWindow();
</script>
{% endjshrink %}
{% endif %}